set -euo pipefail

BASE_VERSION=master
GENERATION_NUMBER=77
LOCAL_BRANCH=build-${GENERATION_NUMBER}
COMMITS=(
	08bd28bc2 # python3Packages.ckcc-protocol: init at 0.7.9
	1d2affa07 # electrum: Add ckcc-protocol
        d0886a69f # ledgeragent: init at 0.9.0
	5d9dd6f0a # pythonPackages.trezor_agent: add hkjn to maintainers
	78bb1905a # trezor_agent: init at 0.10.0
	f72e03391 # ledger_agent: init at 0.9.0
	001584d45 # keepkey_agent: init at 0.9.0
)

echo "Refreshing upstream and channels.."
cd /home/user/src/hkjn.me/nixpkgs
git fetch upstream
git fetch channels

echo "Updating master branch.."
git checkout master
git rebase upstream/master
git push

echo "Updating nixos-unstable branch.."
git checkout nixos-unstable
git rebase remotes/channels/nixos-unstable
git push

echo "Checkout out ${BASE_VERSION}.."
git checkout ${BASE_VERSION}
echo "Creating ${LOCAL_BRANCH} branch.."
git checkout -b ${LOCAL_BRANCH}
for commit in "${COMMITS[@]}"; do
    echo "cherry-picking ${commit}.."
    git cherry-pick ${commit}
done
git push

