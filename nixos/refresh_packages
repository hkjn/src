set -euo pipefail

BASE_VERSION=nixos-19.03
GENERATION_NUMBER=69
LOCAL_BRANCH=build-${GENERATION_NUMBER}
COMMITS=(
	3586ab3   # clightning: 0.6.3 -> 0.7.0 (#56788)
	fbc381e2  # clightning: 0.7.0 -> 0.7.1
	7971cec52 # bitcoin: 0.17.3 -> 0.18.0, enable and run unit tests
	bc0a2e870 # bitcoin: cleanup check-only input, move to checkInputs
	769f992fb # electrum: 3.3.7 -> 3.3.8
	da98d1040 # maintainers: Add hkjn
	08bd28bc2 # python3Packages.ckcc-protocol: init at 0.7.9
	1d2affa07 # electrum: Add ckcc-protocol
)

echo "Refreshing upstream and channels.."
cd /home/user/src/hkjn.me/nixpkgs
git fetch upstream
git fetch channels

echo "Updating master branch.."
git checkout master
git rebase upstream/master
git push

echo "Updating nixos-unstable branch.."
git checkout nixos-unstable
git rebase remotes/channels/nixos-unstable
git push

echo "Checkout out channels/${BASE_VERSION}.."
git checkout channels/${BASE_VERSION}
echo "Creating ${LOCAL_BRANCH} branch.."
git checkout -b ${LOCAL_BRANCH}
for commit in "${COMMITS[@]}"; do
    echo "cherry-picking ${commit}.."
    git cherry-pick ${commit}
done
git push

