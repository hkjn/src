set -euo pipefail

BASE_VERSION=master
GENERATION_NUMBER=81
LOCAL_BRANCH=build-${GENERATION_NUMBER}
COMMITS=(
	6bd628ed4 # python3Packages.ckcc-protocol: init at 0.8.0
	1d2affa07 # electrum: Add ckcc-protocol
)

echo "Refreshing upstream and channels.."
cd /home/user/src/hkjn.me/nixpkgs
git fetch upstream
git fetch channels

echo "Updating master branch.."
git checkout master
git rebase upstream/master
git push

echo "Updating nixos-unstable branch.."
git checkout nixos-unstable
git rebase remotes/channels/nixos-unstable
git push

echo "Checkout out ${BASE_VERSION}.."
git checkout ${BASE_VERSION}
echo "Creating ${LOCAL_BRANCH} branch.."
git checkout -b ${LOCAL_BRANCH}
for commit in "${COMMITS[@]}"; do
    echo "cherry-picking ${commit}.."
    git cherry-pick ${commit}
done
git push

